---
import "../index.css";
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    <script
      defer
      data-domain="haroldthehorse.com"
      src="https://plausible.io/js/script.js"></script>
    <title>Harold the Horse</title>
    <meta
      name="description"
      content="Harold is a horse therapist. He fills his answers with love and horse idioms."
    />
  </head>
  <body>
    <main
      class="flex flex-col items-center justify-center min-h-screen bg-gray-200"
    >
      <h1 class="text-4xl mb-4">Harold the Horse 🐴</h1>
      <form id="ask-form" class="relative w-full max-w-md">
        <textarea
          id="prompt"
          name="prompt"
          rows="4"
          cols="50"
          class="textarea w-full p-4 pr-16 resize-none"
          placeholder="Let me know your problems..."></textarea>
        <button
          id="submit-button"
          class="btn btn-primary absolute bottom-2 right-2"
          type="submit"
        >
          <span id="button-text">Submit</span>
          <span id="button-spinner" class="hidden">
            <svg
              class="animate-spin h-4 w-4"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <circle
                class="opacity-25"
                cx="12"
                cy="12"
                r="10"
                stroke="currentColor"
                stroke-width="4"></circle>
              <path
                class="opacity-75"
                fill="currentColor"
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
          </span>
        </button>
      </form>
      <div id="response" class="mt-4"></div>

      <script>
        const form = document.getElementById("ask-form");
        const textarea = document.getElementById("prompt");
        const response = document.getElementById("response") as HTMLDivElement;
        const submitButton = document.getElementById(
          "submit-button"
        ) as HTMLButtonElement;
        const buttonText = document.getElementById(
          "button-text"
        ) as HTMLSpanElement;
        const buttonSpinner = document.getElementById(
          "button-spinner"
        ) as HTMLSpanElement;

        form?.addEventListener("submit", async (event) => {
          event.preventDefault();
          const prompt = (
            document.getElementById("prompt") as HTMLTextAreaElement
          )?.value;

          submitButton.disabled = true;
          buttonText.classList.add("hidden");
          buttonSpinner.classList.remove("hidden");
          response.textContent = "";

          try {
            const res = await fetch("/api/ask.json", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ prompt }),
            });

            if (!res.ok) {
              throw new Error("Failed to fetch response from API");
            }

            const data = await res.json();
            response.textContent = data.response;
          } catch (error: any) {
            response.textContent = "Error: " + error.message;
          } finally {
            submitButton.disabled = false;
            buttonText.classList.remove("hidden");
            buttonSpinner.classList.add("hidden");
          }
        });

        textarea?.addEventListener("keydown", (event) => {
          if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            form?.dispatchEvent(new Event("submit", { cancelable: true }));
          }
        });
      </script>
    </main>
  </body>
</html>
